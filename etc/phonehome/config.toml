# PhoneHome Server Configuration
# This is an example configuration file for the phonehome application.
# Copy this file to config.toml and modify the values according to your setup.

[server]
# Host to bind the server to (0.0.0.0 for all interfaces, 127.0.0.1 for localhost only)
host = "127.0.0.1"

# Port to listen on for HTTP connections
port = 9690

# Secret token that must be included in the phone home URL
# IMPORTANT: Change this to a secure, random value for production use!
token = "your-secret-token-here-change-me-123456"

[logging]
# Path to the log file
log_file = "/var/log/phonehome/phonehome.log"

# Log level: trace, debug, info, warn, error
log_level = "info"

# Enable file logging with daily rotation
log_to_file = false

# Enable systemd journald logging
log_to_journald = true

# Maximum log file size in MB before rotation (used by tracing-appender)
max_file_size_mb = 100

# Maximum number of rotated log files to keep
max_files = 10



[external_app]
# Command to execute when phone home data is received
# This could be a script, binary, or any executable command
command = "/usr/bin/process-phone-home"

# Arguments to pass to the command
# Use {{PhoneHomeData}} placeholder in any argument to substitute the sanitized phone home data
# Example: ["--input", "{{PhoneHomeData}}"] or ["--data", "{{PhoneHomeData}}", "--format", "json"]
# The {{PhoneHomeData}} placeholder will be replaced with the actual processed data string
args = ["--source", "cloud-init", "--format", "pipe-separated", "--data" , "{{PhoneHomeData}}"]

# Timeout in seconds for the external application execution
timeout_seconds = 30

# Security Settings for External Application
# Maximum length of data that can be passed to external application (in bytes)
max_data_length = 4096

# Whether to encapsulate the data argument in quotes (default: false)
# Set to true if your external application expects quoted arguments
quote_data = true

[phone_home]
# List of fields to extract from the Cloud Init phone home form data
# Available fields include only those officially supported by cloud-init:
#
# Cloud-Init Standard Fields:
# - instance_id: Cloud instance identifier
# - hostname: System hostname
# - fqdn: Fully qualified domain name
# - pub_key_rsa: RSA public key
# - pub_key_ecdsa: ECDSA public key
# - pub_key_ed25519: Ed25519 public key
#
# Note: Only the above fields are officially supported by cloud-init phone home module.
# Any other fields will be ignored by cloud-init and should not be used.
#
# Note: Cloud-init sends data as application/x-www-form-urlencoded
# with the standard fields above. Additional fields can be specified
# and will be extracted if present in the form data.
fields_to_extract = [
    "instance_id",
    "hostname",
    "fqdn",
    "pub_key_rsa",
    "pub_key_ecdsa",
    "pub_key_ed25519"
]

# Separator character to use between extracted fields
field_separator = ", "

# Whether to include a timestamp as the first field
include_timestamp = true

# Whether to include the instance_id as a separate field (even if not in fields_to_extract)
include_instance_id = true

# Output format type for the extracted data
# Available options:
# - "string": Pipe-separated string format (default)
# - "json": JSON object format
# - "sql": SQL INSERT query format
output_type = "string"
