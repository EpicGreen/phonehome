# PhoneHome Server Configuration
# This is an example configuration file for the phonehome application.
# Copy this file to config.toml and modify the values according to your setup.

[server]
# Host to bind the server to (0.0.0.0 for all interfaces, 127.0.0.1 for localhost only)
host = "0.0.0.0"

# Port to listen on for HTTPS connections
port = 443

# Secret token that must be included in the phone home URL
# IMPORTANT: Change this to a secure, random value for production use!
token = "your-secret-token-here-change-me-123456"

[logging]
# Path to the log file
log_file = "/var/log/phonehome/phonehome.log"

# Log level: trace, debug, info, warn, error
log_level = "info"

# Enable console logging (stdout/stderr)
enable_console = true

# Enable file logging
enable_file = true

# Maximum log file size in MB before rotation (used by tracing-appender)
max_file_size_mb = 100

# Maximum number of rotated log files to keep
max_files = 10

[tls]
# Path to the TLS certificate file
# If the file doesn't exist, a self-signed certificate will be generated automatically
# Note: Self-signed certificates are stored in /var/lib/phonehome for better security
cert_path = "/var/lib/phonehome/cert.pem"

# Path to the TLS private key file
# If the file doesn't exist, a private key will be generated automatically
key_path = "/var/lib/phonehome/key.pem"

# For testing without TLS (HTTP mode), comment out the entire [tls] section:
# [tls]
# cert_path = "/var/lib/phonehome/cert.pem"
# key_path = "/var/lib/phonehome/key.pem"

[external_app]
# Command to execute when phone home data is received
# This could be a script, binary, or any executable command
command = "/usr/bin/process-phone-home"

# Arguments to pass to the command (the processed data string will be appended at the end)
args = ["--source", "cloud-init", "--format", "pipe-separated"]

# Timeout in seconds for the external application execution
timeout_seconds = 30

# Working directory for the external application (optional)
# working_directory = "/var/lib/phonehome"

# Environment variables to set for the external application (optional)
# [external_app.environment]
# API_KEY = "your-api-key"
# LOG_LEVEL = "info"

[phone_home]
# List of fields to extract from the Cloud Init phone home data
# Available fields include:
# - instance_id: Cloud instance identifier
# - hostname: System hostname
# - fqdn: Fully qualified domain name
# - cloud_name: Cloud provider name (aws, gce, azure, etc.)
# - platform: Platform information
# - region: Cloud region
# - availability_zone: Availability zone
# - instance_type: Instance type/size
# - local_hostname: Local hostname
# - public_keys: SSH public keys (comma-separated)
# - local_ipv4: Local IPv4 address
# - public_ipv4: Public IPv4 address
# - local_ipv6: Local IPv6 address
# - public_ipv6: Public IPv6 address
# - mac: MAC address
# - security_groups: Security groups (comma-separated)
# You can also specify custom fields that may be present in the phone home data
fields_to_extract = [
    "instance_id",
    "hostname",
    "fqdn",
    "public_ipv4",
    "local_ipv4",
    "cloud_name",
    "region",
    "availability_zone",
    "instance_type"
]

# Separator character to use between extracted fields
field_separator = "|"

# Whether to include a timestamp as the first field
include_timestamp = true

# Whether to include the instance_id as a separate field (even if not in fields_to_extract)
include_instance_id = true

# Example Cloud Init configuration to add to your user-data:
#
# #cloud-config
# phone_home:
#   url: "https://your-domain.com:8443/phone-home/your-secret-token-here-change-me-123456"
#   post: all
#   tries: 10
#
# The phone home URL format is:
# https://{server.host}:{server.port}/phone-home/{server.token}

# Example external application script (/usr/local/bin/process-phone-home):
#
# #!/bin/bash
# # Example script to process phone home data
# DATA="$1"
# echo "Received phone home data: $DATA" >> /var/log/phonehome.log
#
# # Parse the pipe-separated data
# IFS='|' read -ra FIELDS <<< "$DATA"
# TIMESTAMP="${FIELDS[0]}"
# INSTANCE_ID="${FIELDS[1]}"
# HOSTNAME="${FIELDS[2]}"
# PUBLIC_IP="${FIELDS[3]}"
# LOCAL_IP="${FIELDS[4]}"
# CLOUD_NAME="${FIELDS[5]}"
# REGION="${FIELDS[6]}"
#
# # Do something with the data (send to monitoring system, update database, etc.)
# echo "Instance $INSTANCE_ID ($HOSTNAME) is online at $PUBLIC_IP in $CLOUD_NAME/$REGION"

# Certificate Management
# The server can automatically generate self-signed certificates if the certificate
# files specified above do not exist. This is useful for testing and development.
# Self-signed certificates are now stored in /var/lib/phonehome/ by default.
# For production use, provide your own certificate files or use a certificate
# authority like Let's Encrypt with certbot:
#
# sudo certbot certonly --standalone -d your-domain.com
# Then update cert_path and key_path to point to the generated certificates.

# Testing and Demo Examples:
# For development/testing, you can run with different configurations:
#
# 1. Production mode (HTTPS with auto-generated certs):
#    cargo run -- --config /etc/phonehome/config.toml
#
# 2. Debug mode with detailed logging:
#    cargo run -- --config /etc/phonehome/config.toml --debug
#
# 3. HTTP mode for local testing (comment out [tls] section and use port 8080):
#    host = "127.0.0.1"
#    port = 8080
#
# 4. Test commands for local development:
#    # Landing page: curl http://127.0.0.1:8080/
#    # Health check: curl http://127.0.0.1:8080/health
#    # Phone home: curl -X POST http://127.0.0.1:8080/phone-home/your-token \
#    #   -H "Content-Type: application/json" \
#    #   -d '{"instance_id": "i-demo123", "hostname": "demo-server"}'
#    # Test 404: curl http://127.0.0.1:8080/invalid
#    # Test auth error: curl -X POST http://127.0.0.1:8080/phone-home/wrong-token \
#    #   -H "Content-Type: application/json" -d '{}'

# Web Interface:
# The server includes a web interface accessible via browser:
# - Landing page: https://your-server.com:8443/
# - Health check: https://your-server.com:8443/health
# - Custom error pages for 404, 401, 400, 500 errors

# Security Notes:
# 1. Always use HTTPS in production
# 2. Use a strong, random token
# 3. Restrict access to the server using firewall rules
# 4. Regularly rotate the token
# 5. Monitor the logs for suspicious activity
# 6. Ensure the external application is secure and validated
# 7. Use proper certificate management for production deployments
# 8. Self-signed certificates should only be used for testing or internal use
# 9. Certificate and key files are now stored in /var/lib/phonehome/ by default
# 10. Log files are stored in /var/log/phonehome/ with rotation support
